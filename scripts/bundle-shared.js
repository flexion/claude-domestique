#!/usr/bin/env node
/**
 * Bundle shared module into each plugin
 *
 * Claude Code installs plugins individually to ~/.claude/plugins/cache/<plugin>/<version>/
 * This means workspace dependencies won't resolve at runtime. We bundle the shared
 * module into each plugin so they're self-contained.
 *
 * Usage: node scripts/bundle-shared.js
 */

const fs = require('fs');
const path = require('path');

const ROOT = path.join(__dirname, '..');
const SHARED_SRC = path.join(ROOT, 'shared', 'index.js');
const PLUGINS = ['mantra', 'memento', 'onus'];

function bundle() {
  // Read shared module
  if (!fs.existsSync(SHARED_SRC)) {
    console.error('Error: shared/index.js not found');
    process.exit(1);
  }

  const sharedContent = fs.readFileSync(SHARED_SRC, 'utf8');

  // Copy to each plugin
  for (const plugin of PLUGINS) {
    const destDir = path.join(ROOT, plugin, 'lib');
    const destFile = path.join(destDir, 'shared.js');

    // Create lib directory if needed
    if (!fs.existsSync(destDir)) {
      fs.mkdirSync(destDir, { recursive: true });
    }

    // Add header comment
    const header = `/**
 * @claude-domestique/shared - bundled copy
 * DO NOT EDIT - this file is auto-generated by scripts/bundle-shared.js
 * Edit shared/index.js instead and run: npm run build
 */

`;

    fs.writeFileSync(destFile, header + sharedContent);
    console.log(`Bundled shared into ${plugin}/lib/shared.js`);
  }

  console.log('Done!');
}

bundle();
